<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acceso a Demos | Automapymes</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        grid-template-columns: 1.3fr 0.8fr;
        gap: 2rem;
      }
      .left-panel,
      .right-panel {
        padding: 1.5rem;
        border-radius: 1rem;
      }
      @media (max-width: 900px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }
      }
    </style>
  </head>

  <body class="bg-gray-50 md:overflow-hidden" x-data="demoAccess()">
    <!-- Header -->
    <nav class="bg-white shadow-sm fixed w-full z-50">
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16"
      >
        <a href="/" class="text-2xl font-bold gradient-text">Automapymes</a>
        <a href="/" class="text-purple-600 font-semibold hover:underline"
          >‚Üê Volver</a
        >
      </div>
    </nav>

    <!-- Spacer bajo la nav fija solo en escritorio -->
    <div class="hidden md:block h-16"></div>

    <!-- √Årea principal: en m√≥vil scroll normal; en escritorio encaje exacto -->
    <main
      class="px-4 pt-24 pb-16 md:pt-0 md:pb-0 md:h-[calc(100vh-4rem-3rem)] md:flex md:items-center md:justify-center"
    >
      <!-- Layout para formularios (antes de generar token) -->
      <div
        x-show="!tokenGenerated"
        class="max-w-7xl mx-auto w-full grid md:grid-cols-2 gap-8 items-start md:items-center"
      >
        <!-- Card informativa a la izquierda -->
        <aside
          class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 md:p-8"
        >
          <h2 class="text-base md:text-lg font-bold text-blue-900 mb-3">
            ‚ÑπÔ∏è ¬øPor qu√© necesito contrase√±a?
          </h2>
          <ul class="space-y-2 text-sm md:text-base text-blue-800">
            <li>‚Ä¢ Las demos usan IA de pago (Anthropic)</li>
            <li>‚Ä¢ Limitamos el acceso para controlar costes</li>
            <li>‚Ä¢ Cada token tiene 60 requests gratis</li>
            <li>‚Ä¢ V√°lido por 3 d√≠as</li>
          </ul>

          <div class="mt-6 pt-6 border-t border-blue-300">
            <h3 class="font-bold text-blue-900 mb-2">¬øPrimera vez aqu√≠?</h3>
            <p class="text-sm text-blue-800 mb-3">
              Si no tienes contrase√±a, primero solicita acceso con tu email.
            </p>
            <button
              @click="showRegister"
              x-show="!isRegisterMode"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition"
            >
              Solicitar Acceso
            </button>
            <button
              @click="showLogin"
              x-show="isRegisterMode"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition"
            >
              Ya tengo contrase√±a
            </button>
          </div>
        </aside>

        <!-- Formulario / Card derecha -->
        <div class="bg-white rounded-2xl shadow-2xl w-full p-6 md:p-8">
          <!-- MODO: Solicitar Acceso (Registro) -->
          <div x-show="isRegisterMode && !tokenGenerated">
            <div class="text-center mb-8">
              <div class="text-5xl mb-4">üìß</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Solicitar Acceso
              </h1>
              <p class="text-gray-600">
                Introduce tu email y te enviaremos una contrase√±a
              </p>
            </div>

            <form @submit.prevent="register" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Email</label
                >
                <input
                  type="email"
                  x-model="email"
                  required
                  placeholder="tu@email.com"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 transition"
                />
              </div>

              <div
                x-show="error"
                class="bg-red-50 border-l-4 border-red-500 p-4 rounded"
              >
                <p class="text-sm text-red-700" x-text="error"></p>
              </div>

              <div
                x-show="success"
                class="bg-green-50 border-l-4 border-green-500 p-4 rounded"
              >
                <p class="text-sm text-green-700" x-text="success"></p>
              </div>

              <button
                type="submit"
                :disabled="loading"
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50 transition"
              >
                <span x-show="!loading">Enviar Contrase√±a a mi Email</span>
                <span x-show="loading">Enviando...</span>
              </button>
            </form>

            <div class="mt-4 text-center">
              <button
                @click="showLogin"
                class="text-purple-600 hover:underline text-sm"
              >
                ¬øYa tienes contrase√±a? Inicia sesi√≥n ‚Üí
              </button>
            </div>
          </div>

          <!-- MODO: Iniciar Sesi√≥n (Login) -->
          <div x-show="!isRegisterMode && !tokenGenerated">
            <div class="text-center mb-8">
              <div class="text-5xl mb-4">üîê</div>
              <h1 class="text-3xl font-bold text-gray-800 mb-2">
                Iniciar Sesi√≥n
              </h1>
              <p class="text-gray-600">
                Introduce tu email y contrase√±a para obtener tu token
              </p>
            </div>

            <form @submit.prevent="login" class="space-y-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Email</label
                >
                <input
                  type="email"
                  x-model="email"
                  required
                  placeholder="tu@email.com"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 transition"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2"
                  >Contrase√±a de Acceso</label
                >
                <input
                  type="password"
                  x-model="password"
                  required
                  placeholder="Contrase√±a enviada por email"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 transition"
                />
              </div>

              <div
                x-show="error"
                class="bg-red-50 border-l-4 border-red-500 p-4 rounded"
              >
                <p class="text-sm text-red-700" x-text="error"></p>
              </div>

              <button
                type="submit"
                :disabled="loading"
                class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-indigo-700 disabled:opacity-50 transition"
              >
                <span x-show="!loading">Obtener Token de Acceso</span>
                <span x-show="loading">Generando...</span>
              </button>
            </form>

            <div class="mt-4 text-center">
              <button
                @click="showRegister"
                class="text-purple-600 hover:underline text-sm"
              >
                ¬øNo tienes contrase√±a? Solic√≠tala aqu√≠ ‚Üí
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Layout para token generado (dos columnas en escritorio) -->
      <div x-show="tokenGenerated" class="container">
        <!-- Panel izquierdo: Token -->
        <div class="left-panel space-y-6">
          <div class="bg-green-50 border-2 border-green-500 rounded-lg p-6">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-3xl">‚úÖ</span>
              <div>
                <h3 class="font-bold text-green-900">Token Generado</h3>
                <p class="text-sm text-green-700">
                  Gu√°rdalo en un lugar seguro
                </p>
              </div>
            </div>

            <div class="bg-white rounded-lg p-4 mb-4">
              <p class="text-xs text-gray-600 mb-2 font-semibold">Tu Token:</p>
              <code
                x-text="accessToken"
                class="block text-xs break-all bg-gray-100 p-3 rounded font-mono text-gray-800"
              ></code>
              <button
                @click="copyToken"
                class="mt-3 w-full bg-purple-600 text-white py-2 rounded text-sm font-semibold hover:bg-purple-700 transition"
              >
                <span x-show="!copied">üìã Copiar Token</span>
                <span x-show="copied">‚úÖ Copiado!</span>
              </button>
            </div>

            <div class="text-sm text-gray-700 space-y-2">
              <p>
                ‚Ä¢ <strong>Requests disponibles:</strong>
                <span x-text="requestsAvailable"></span>
              </p>
              <p>
                ‚Ä¢ <strong>V√°lido por:</strong>
                <span x-text="expiresTime"></span>
              </p>
              <p>‚Ä¢ <strong>Email:</strong> <span x-text="email"></span></p>
            </div>
          </div>

          <div class="bg-gray-50 rounded-lg p-6">
            <h3 class="font-bold text-gray-900 mb-3">üìù C√≥mo usar tu token:</h3>
            <ol class="text-sm text-gray-700 space-y-3">
              <li class="flex gap-2">
                <span class="font-bold text-purple-600">1.</span>
                <span>Copia el token con el bot√≥n de arriba</span>
              </li>
              <li class="flex gap-2">
                <span class="font-bold text-purple-600">2.</span>
                <span>Ve a cualquier demo que quieras probar</span>
              </li>
              <li class="flex gap-2">
                <span class="font-bold text-purple-600">3.</span>
                <span>Pega el token cuando te lo pida la demo</span>
              </li>
              <li class="flex gap-2">
                <span class="font-bold text-purple-600">4.</span>
                <span>¬°Listo! Ya puedes probar todas las funciones</span>
              </li>
            </ol>
          </div>

          <button
            @click="reset"
            class="w-full text-purple-600 py-3 rounded-lg font-semibold hover:bg-purple-50 transition"
          >
            ‚Üê Generar otro token
          </button>
        </div>

        <!-- Panel derecho: Listado de demos -->
        <div class="right-panel">
          <div class="space-y-2">
            <h3 class="font-semibold text-gray-800 mb-3">
              üöÄ Acceder a las Demos:
            </h3>
            <a
              href="https://chatbot.automapymes.com"
              target="_blank"
              class="block bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">ü§ñ Chatbot IA</p>
                  <p class="text-xs text-gray-600">Atenci√≥n al cliente 24/7</p>
                </div>
                <span class="text-purple-600">‚Üí</span>
              </div>
            </a>
            <a
              href="https://whatsappbot.automapymes.com"
              target="_blank"
              class="block bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">üí¨ WhatsApp Bot IA</p>
                  <p class="text-xs text-gray-600">
                    Automatizaci√≥n WhatsApp Business
                  </p>
                </div>
                <span class="text-purple-600">‚Üí</span>
              </div>
            </a>
            <a
              href="https://pdfprocessor.automapymes.com"
              target="_blank"
              class="block bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">
                    üìÑ Procesador Documentos
                  </p>
                  <p class="text-xs text-gray-600">
                    Extrae datos de PDFs autom√°ticamente
                  </p>
                </div>
                <span class="text-purple-600">‚Üí</span>
              </div>
            </a>
            <a
              href="https://analytics.automapymes.com"
              target="_blank"
              class="block bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-purple-500 transition"
            >
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-gray-800">
                    üìä Dashboard Analytics
                  </p>
                  <p class="text-xs text-gray-600">An√°lisis de datos con IA</p>
                </div>
                <span class="text-purple-600">‚Üí</span>
              </div>
            </a>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer: fijo solo en escritorio, normal en m√≥vil -->
    <footer
      class="text-center text-gray-500 text-sm py-8 md:fixed md:bottom-0 md:left-0 md:right-0 md:h-12 md:flex md:items-center md:justify-center md:bg-transparent"
    >
      ¬© Automapymes ‚Äì Desarrollado por Jorge Lago Campos
    </footer>

    <script>
      function demoAccess() {
        return {
          // Estados
          isRegisterMode: false,
          email: "",
          password: "",
          loading: false,
          error: "",
          success: "",
          tokenGenerated: false,
          accessToken: "",
          requestsAvailable: 0,
          expiresTime: "", // mostrar d√≠as, horas, minutos
          copied: false,

          // URL del AuthService
          AUTH_SERVICE_URL: "https://auth.automapymes.com",

          // Cambiar entre modos
          showRegister() {
            this.isRegisterMode = true;
            this.error = "";
            this.success = "";
            this.password = "";
          },

          showLogin() {
            this.isRegisterMode = false;
            this.error = "";
            this.success = "";
          },

          // ---------- Funci√≥n helper para calcular tiempo restante ----------
          parseISOtoDate(isoString) {
            // Esto asegura que cualquier offset se interprete correctamente
            const parts = isoString.match(
              /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})([+-]\d{2}):(\d{2})$/
            );
            if (!parts) return new Date(NaN); // fecha inv√°lida

            const [_, y, m, d, h, min, s, tzH, tzM] = parts.map(Number);

            // Crear fecha en UTC
            const date = new Date(Date.UTC(y, m - 1, d, h, min, s));
            const offset = tzH * 60 + tzM;
            // Restar offset en minutos
            date.setUTCMinutes(date.getUTCMinutes() - offset);
            return date;
          },

          formatRemainingTime(expiresAt) {
            const expiresDate = this.parseISOtoDate(expiresAt);
            if (isNaN(expiresDate.getTime())) return "fecha desconocida";

            let diffMs = expiresDate - new Date();
            if (diffMs <= 0) return "Expirado";

            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(
              (diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
            );
            const diffMinutes = Math.floor(
              (diffMs % (1000 * 60 * 60)) / (1000 * 60)
            );

            return `${diffDays} d√≠as ${diffHours} horas ${diffMinutes} minutos`;
          },

          // Registro de nuevo usuario
          async register() {
            this.loading = true;
            this.error = "";
            this.success = "";

            try {
              const response = await fetch(
                `${this.AUTH_SERVICE_URL}/auth/register`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ email: this.email }),
                }
              );

              const data = await response.json();

              if (!response.ok) {
                if (response.status === 409) {
                  this.error =
                    "Este email ya est√° registrado. Cambiando a inicio de sesi√≥n...";
                  setTimeout(() => {
                    this.showLogin();
                  }, 2000);
                  return;
                }
                throw new Error(data.detail || "Error al solicitar acceso");
              }

              this.success =
                "¬°Contrase√±a enviada a tu email! Revisa tu bandeja de entrada (y spam).";
              setTimeout(() => {
                this.showLogin();
                this.success = "";
              }, 3000);
            } catch (err) {
              this.error = err.message;
            } finally {
              this.loading = false;
            }
          },

          // Login de usuario existente
          async login() {
            this.loading = true;
            this.error = "";

            try {
              const response = await fetch(
                `${this.AUTH_SERVICE_URL}/auth/login`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    email: this.email,
                    password: this.password,
                  }),
                }
              );

              const data = await response.json();

              if (!response.ok) {
                if (response.status === 401) {
                  throw new Error(
                    "Credenciales incorrectas. Verifica tu email y contrase√±a."
                  );
                }
                throw new Error(data.detail || "Error al iniciar sesi√≥n");
              }

              // ‚úî Login OK
              this.accessToken = data.access_token;
              this.requestsAvailable = data.requests_left;

              // Calcular tiempo restante desde expires_at
              this.expiresTime = this.formatRemainingTime(data.expires_at);
              this.tokenGenerated = true;

              // Guardar en localStorage
              localStorage.setItem("demo_token", data.access_token);
              localStorage.setItem("demo_email", this.email);
              localStorage.setItem("demo_expires", data.expires_at);
            } catch (err) {
              this.error = err.message;
            } finally {
              this.loading = false;
            }
          },

          // Copiar token al portapapeles
          copyToken() {
            navigator.clipboard.writeText(this.accessToken);
            this.copied = true;
            setTimeout(() => {
              this.copied = false;
            }, 2000);
          },

          // Reset para generar nuevo token
          reset() {
            this.tokenGenerated = false;
            this.accessToken = "";
            this.password = "";
            this.error = "";
            this.success = "";
            this.isRegisterMode = false;
            this.requestsAvailable = 0;
            this.expiresTime = "";
          },

          // Al cargar, verificar si hay token guardado
          init() {
            const savedToken = localStorage.getItem("demo_token");
            const savedEmail = localStorage.getItem("demo_email");
            const savedExpires = localStorage.getItem("demo_expires");

            if (savedToken && savedEmail && savedExpires) {
              this.email = savedEmail;
              this.accessToken = savedToken;

              // Calcular tiempo restante
              this.expiresTime = this.formatRemainingTime(savedExpires);

              // Actualizar requests disponibles desde backend
              fetch(`${this.AUTH_SERVICE_URL}/auth/stats?token=${savedToken}`)
                .then((res) => res.json())
                .then((data) => {
                  this.requestsAvailable = data.requests_left;
                })
                .catch((err) => {
                  console.error(err);
                  this.requestsAvailable = 0;
                });

              this.tokenGenerated = true;
            }
          },
        };
      }
    </script>
  </body>
</html>
